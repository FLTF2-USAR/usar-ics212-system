import{c as E,b as x,L as g,D as T,A as b}from"./config-C906d-I9.js";import{r as k,j as $,_ as j}from"./index-4oHEt-lW.js";const A=[["path",{d:"M8 2v4",key:"1cmpym"}],["path",{d:"M16 2v4",key:"4m81vk"}],["rect",{width:"18",height:"18",x:"3",y:"4",rx:"2",key:"1hopcy"}],["path",{d:"M3 10h18",key:"8toen8"}]],U=E("calendar",A);const F=[["path",{d:"M20 6 9 17l-5-5",key:"1gmf2c"}]],O=E("check",F);const P=[["path",{d:"M21.801 10A10 10 0 1 1 17 3.335",key:"yps3ct"}],["path",{d:"m9 11 3 3L22 4",key:"1pflzl"}]],R=E("circle-check-big",P);const v=[["path",{d:"m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3",key:"wmoenq"}],["path",{d:"M12 9v4",key:"juzpu7"}],["path",{d:"M12 17h.01",key:"p32p05"}]],H=E("triangle-alert",v);const C=[["path",{d:"M18 6 6 18",key:"1bl5f8"}],["path",{d:"m6 6 12 12",key:"d8bk6v"}]],I=E("x",C),G=({isOpen:n,onClose:e,title:t,children:s,className:r})=>(k.useEffect(()=>(n?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[n]),n?$.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[$.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:e}),$.jsxs("div",{className:x("relative bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 max-h-[90vh] overflow-y-auto",r),children:[$.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-gray-200",children:[$.jsx("h2",{className:"text-xl font-semibold text-gray-900",children:t}),$.jsx("button",{onClick:e,className:"p-1 hover:bg-gray-100 rounded-lg transition-colors",children:$.jsx(I,{className:"w-5 h-5 text-gray-500"})})]}),$.jsx("div",{className:"px-6 py-4",children:s})]})]}):null),u="https://mbfd-github-proxy.pdarleyjr.workers.dev/api";class M{adminPassword=null;constructor(){}setAdminPassword(e){this.adminPassword=e}clearAdminPassword(){this.adminPassword=null}isAdminAuthenticated(){return this.adminPassword!==null}getHeaders(e=!1){const t={"Content-Type":"application/json"};return e&&this.adminPassword&&(t["X-Admin-Password"]=this.adminPassword),t}async checkExistingDefects(e){try{const t=await fetch(`${u}/issues?state=open&labels=${g.DEFECT},${encodeURIComponent(e)}&per_page=100`,{method:"GET",headers:this.getHeaders()});if(!t.ok)return console.warn(`Failed to fetch defects: ${t.statusText}`),new Map;const s=await t.json(),r=Array.isArray(s)?s:[],c=new Map;for(const h of r){const a=h.title.match(T);if(a){const[,,i,o]=a,d=`${i}:${o}`;c.set(d,h)}}return c}catch(t){return console.error("Error fetching existing defects:",t),new Map}}async submitChecklist(e){const{user:t,apparatus:s,date:r,defects:c}=e,h=await this.checkExistingDefects(s);let a=0;const i=[];for(const o of c)try{const d=`${o.compartment}:${o.item}`,l=h.get(d);l?await this.addCommentToDefect(l.number,t.name,t.rank,r,o.notes,o.photoUrl):await this.createDefectIssue(s,o.compartment,o.item,o.status,o.notes,t.name,t.rank,r,o.photoUrl)}catch(d){a++;const l=`${o.compartment}:${o.item}`;i.push(l),console.error(`Failed to process defect ${l}:`,d)}if(a>0)throw new Error(`Failed to submit ${a} defect(s): ${i.join(", ")}. Please try again.`);if(await this.createLogEntry(e),c.length>0)try{await this.createSupplyTasksForDefects(c,s)}catch(o){console.error("Failed to create supply tasks (non-fatal):",o)}}async createDefectIssue(e,t,s,r,c,h,a,i,o){const d=`[${e}] ${t}: ${s} - ${r==="missing"?"Missing":"Damaged"}`;let l=`
## Defect Report

**Apparatus:** ${e}
**Compartment:** ${t}
**Item:** ${s}
**Status:** ${r==="missing"?"âŒ Missing":"âš ï¸ Damaged"}
**Reported By:** ${h} (${a})
**Date:** ${i}

### Notes
${c}
`;o&&(l+=`
### Photo Evidence

![Defect Photo](${o})
`),l+=`
---
*This issue was automatically created by the MBFD Checkout System.*`,l=l.trim();const p=[g.DEFECT,e];r==="damaged"&&p.push(g.DAMAGED);try{const f=await fetch(`${u}/issues`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({title:d,body:l,labels:p})});if(!f.ok)throw new Error(`Failed to create issue: ${f.statusText}`)}catch(f){throw console.error("Error creating defect issue:",f),f}}async addCommentToDefect(e,t,s,r,c,h){let a=`
### Verification Update

**Verified still present by:** ${t} (${s})
**Date:** ${r}

${c?`**Additional Notes:** ${c}`:""}
`;h&&(a+=`
### Photo Evidence

![Defect Photo](${h})
`),a+=`
---
*This comment was automatically added by the MBFD Checkout System.*`,a=a.trim();try{const i=await fetch(`${u}/issues/${e}/comments`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({body:a})});if(!i.ok)throw new Error(`Failed to add comment: ${i.statusText}`)}catch(i){throw console.error("Error adding comment to issue:",i),i}}async createLogEntry(e){const{user:t,apparatus:s,date:r,items:c}=e,h=`[${s}] Daily Inspection - ${r}`;let a=null,i="";try{const{buildReceiptPayloadFromInspection:d,createHostedReceipt:l,buildReceiptMarkdown:p}=await j(async()=>{const{buildReceiptPayloadFromInspection:y,createHostedReceipt:S,buildReceiptMarkdown:D}=await import("./receipt-nVCul5S8.js");return{buildReceiptPayloadFromInspection:y,createHostedReceipt:S,buildReceiptMarkdown:D}},[]),f=d(e);try{a=(await l(u,f,this.adminPassword||void 0)).url,console.log(`Created hosted receipt: ${a}`)}catch(y){console.error("Failed to create hosted receipt, using fallback:",y),i=p(f)}}catch(d){console.error("Receipt module import failed:",d)}let o=`
## Daily Inspection Log

**Apparatus:** ${s}
**Conducted By:** ${t.name} (${t.rank})
**Date:** ${r}

### Summary
- **Total Items Checked:** ${c.length}
- **Issues Found:** ${e.defects.length}

${e.defects.length>0?`
### Issues Reported
${e.defects.map(d=>`- ${d.compartment}: ${d.item} - ${d.status==="missing"?"âŒ Missing":"âš ï¸ Damaged"}`).join(`
`)}`:"âœ… All items present and working"}
`;a?o+=`

---

ðŸ“‹ **[View Full Printable Receipt](${a})**

_This receipt contains the complete inspection details in a print-friendly format._
`:i&&(o+=`

---

${i}
`),o+=`
---
*This inspection log was automatically created by the MBFD Checkout System.*`,o=o.trim();try{const d=await fetch(`${u}/issues`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({title:h,body:o,labels:[g.LOG,s]})});if(!d.ok)throw new Error(`Failed to create log: ${d.statusText}`);const l=await d.json(),p=await fetch(`${u}/issues/${l.number}`,{method:"PATCH",headers:this.getHeaders(),body:JSON.stringify({state:"closed"})});if(p.ok)console.log(`Successfully created and closed log issue #${l.number}`);else{const f=await p.text();let y;try{y=JSON.parse(f)}catch{y={message:f}}console.error(`Failed to close log issue #${l.number}:`,{status:p.status,statusText:p.statusText,error:y,message:y.message||"Unknown error"}),console.warn(`Log entry created as issue #${l.number} but could not be closed. It may require manual closure or token permissions review.`)}}catch(d){throw console.error("Error creating log entry:",d),d}}async getAllDefects(){try{const e=await fetch(`${u}/issues?state=open&labels=${g.DEFECT}&per_page=100`,{method:"GET",headers:this.getHeaders(!0)});if(!e.ok)throw e.status===401?new Error("Unauthorized. Please enter the admin password."):new Error(`Failed to fetch defects: ${e.statusText}`);const t=await e.json();return(Array.isArray(t)?t:[]).map(r=>this.parseDefectFromIssue(r))}catch(e){throw console.error("Error fetching all defects:",e),e}}parseDefectFromIssue(e){const t=e.title.match(T);let s="Rescue 1",r="Unknown",c="Unknown",h="missing";t&&(s=t[1],r=t[2],c=t[3],h=t[4].toLowerCase());let a;if(e.body){const i=e.body.match(/!\[.*?\]\((https?:\/\/[^\)]+)\)/);i&&(a=i[1])}return{issueNumber:e.number,apparatus:s,compartment:r,item:c,status:h,notes:e.body||"",reportedBy:e.user?.login||"Unknown",reportedAt:e.created_at,updatedAt:e.updated_at,resolved:!1,photoUrl:a}}async resolveDefect(e,t,s){try{const r=await fetch(`${u}/issues/${e}`,{method:"GET",headers:this.getHeaders(!0)});if(!r.ok)throw new Error(`Failed to fetch issue details: ${r.statusText}`);const a=(await r.json()).labels.map(d=>d.name).find(d=>b.includes(d)),i=[g.DEFECT,g.RESOLVED];a&&i.push(a),await fetch(`${u}/issues/${e}/comments`,{method:"POST",headers:this.getHeaders(!0),body:JSON.stringify({body:`
## âœ… Defect Resolved

**Resolved By:** ${s}
**Date:** ${new Date().toISOString()}

### Resolution
${t}

---
*This defect was marked as resolved via the MBFD Admin Dashboard.*
`.trim()})});const o=await fetch(`${u}/issues/${e}`,{method:"PATCH",headers:this.getHeaders(!0),body:JSON.stringify({state:"closed",labels:i})});if(!o.ok)throw o.status===401?new Error("Unauthorized. Please enter the admin password."):new Error(`Failed to resolve defect: ${o.statusText}`)}catch(r){throw console.error("Error resolving defect:",r),r}}async getFleetStatus(){const e=await this.getAllDefects();return this.computeFleetStatus(e)}computeFleetStatus(e){const t=new Map;for(const s of b)t.set(s,0);return e.forEach(s=>{const r=t.get(s.apparatus)||0;t.set(s.apparatus,r+1)}),t}async getInspectionLogs(e=7){try{const t=new Date;t.setDate(t.getDate()-e);const s=await fetch(`${u}/issues?state=all&labels=${g.LOG}&per_page=100&since=${t.toISOString()}`,{method:"GET",headers:this.getHeaders(!0)});if(!s.ok)throw s.status===401?new Error("Unauthorized. Please enter the admin password."):new Error(`Failed to fetch logs: ${s.statusText}`);const r=await s.json();return Array.isArray(r)?r:[]}catch(t){throw console.error("Error fetching inspection logs:",t),t}}async getDailySubmissions(){try{const e=await this.getInspectionLogs(1),t=await this.getInspectionLogs(30),s=new Date().toLocaleDateString("en-US"),r=[],c=new Map,h=new Map;return b.forEach(a=>{c.set(a,0)}),t.forEach(a=>{const i=a.title.match(/\[(.+)\]\s+Daily Inspection/);if(i){const o=i[1],d=c.get(o)||0;c.set(o,d+1);const l=new Date(a.created_at).toLocaleDateString("en-US"),p=h.get(o);(!p||new Date(a.created_at)>new Date(p))&&h.set(o,l)}}),e.forEach(a=>{const i=a.title.match(/\[(.+)\]\s+Daily Inspection/);if(i){const o=i[1];new Date(a.created_at).toLocaleDateString("en-US")===s&&!r.includes(o)&&r.push(o)}}),{today:r,totals:c,lastSubmission:h}}catch(e){throw console.error("Error getting daily submissions:",e),e}}async analyzeLowStockItems(){try{const e=new Date;e.setDate(e.getDate()-30);const t=await fetch(`${u}/issues?state=all&labels=${g.DEFECT}&per_page=100&since=${e.toISOString()}`,{method:"GET",headers:this.getHeaders(!0)});if(!t.ok)throw new Error(`Failed to fetch defects for analysis: ${t.statusText}`);const s=await t.json(),r=new Map;return s.forEach(h=>{if(h.title.includes("Missing")){const a=h.title.match(T);if(a){const[,i,o,d]=a,l=`${o}:${d}`;if(r.has(l)){const p=r.get(l);p.apparatus.add(i),p.occurrences++}else r.set(l,{compartment:o,apparatus:new Set([i]),occurrences:1})}}}),Array.from(r.entries()).filter(([,h])=>h.occurrences>=2).map(([h,a])=>({item:h.split(":")[1],compartment:a.compartment,apparatus:Array.from(a.apparatus),occurrences:a.occurrences})).sort((h,a)=>a.occurrences-h.occurrences)}catch(e){throw console.error("Error analyzing low stock items:",e),e}}async sendNotification(e){try{const t=await fetch(`${u}/notify`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify(e)});if(!t.ok)throw new Error("Failed to send notification");return t.json()}catch(t){throw console.error("Error sending notification:",t),t}}async getEmailConfig(e){try{const t=await fetch(`${u}/config/email`,{method:"GET",headers:{"X-Admin-Password":e}});if(!t.ok)throw t.status===401?new Error("Unauthorized"):new Error("Failed to fetch email configuration");return t.json()}catch(t){throw console.error("Error fetching email config:",t),t}}async updateEmailConfig(e,t){try{const s=await fetch(`${u}/config/email`,{method:"PUT",headers:{"Content-Type":"application/json","X-Admin-Password":e},body:JSON.stringify(t)});if(!s.ok)throw s.status===401?new Error("Unauthorized"):new Error("Failed to update email configuration");return s.json()}catch(s){throw console.error("Error updating email config:",s),s}}async sendManualDigest(e){const t=await fetch(`${u}/digest/send`,{method:"POST",headers:{"X-Admin-Password":e}});if(!t.ok)throw t.status===401?new Error("Unauthorized"):new Error("Failed to send digest");return t.json()}async getAIInsights(e,t="week",s){const r=new URLSearchParams({timeframe:t,...s&&{apparatus:s}}),c=await fetch(`${u}/analyze?${r}`,{method:"GET",headers:{"X-Admin-Password":e}});if(!c.ok)throw c.status===401?new Error("Unauthorized"):c.status===503?new Error("AI features not enabled"):new Error("Failed to fetch AI insights");return c.json()}async createSupplyTasksForDefects(e,t){try{const s=await fetch(`${u}/tasks/create`,{method:"POST",headers:this.getHeaders(),body:JSON.stringify({defects:e,apparatus:t})});if(!s.ok)throw new Error(`Failed to create supply tasks: ${s.statusText}`);const r=await s.json();console.log(`Created ${r.tasksCreated||0} supply tasks from ${e.length} defects`)}catch(s){throw console.error("Error creating supply tasks:",s),s}}}const q=new M,w="https://mbfd-github-proxy.pdarleyjr.workers.dev/api";function m(n=!1){const e={"Content-Type":"application/json"};if(n){const t=localStorage.getItem("adminPassword");t&&(e["X-Admin-Password"]=t)}return e}async function J(){const n=await fetch(`${w}/inventory`,{method:"GET",headers:m(!0)});if(!n.ok){const e=await n.json().catch(()=>({error:"Unknown error"}));throw new Error(e.error||`Failed to fetch inventory: ${n.statusText}`)}return await n.json()}async function z(n="pending"){const e=await fetch(`${w}/tasks?status=${n}`,{method:"GET",headers:m(!0)});if(!e.ok){const t=await e.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to fetch tasks: ${e.statusText}`)}return await e.json()}async function B(n){const e=await fetch(`${w}/tasks`,{method:"POST",headers:{"Content-Type":"application/json",...m(!1)},body:JSON.stringify({tasks:n})});if(!e.ok){const t=await e.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to create tasks: ${e.statusText}`)}return await e.json()}async function V(n,e){const t=await fetch(`${w}/tasks/${n}`,{method:"PATCH",headers:{"Content-Type":"application/json",...m(!0)},body:JSON.stringify(e)});if(!t.ok){const s=await t.json().catch(()=>({error:"Unknown error"}));throw new Error(s.error||`Failed to update task: ${t.statusText}`)}return await t.json()}async function X(n){const e=await fetch(`${w}/ai/inventory-insights`,{method:"POST",headers:{"Content-Type":"application/json",...m(!0)},body:JSON.stringify({tasks:n.tasks?.map(t=>({id:t.id,apparatus:t.apparatus,itemName:t.itemName,deficiencyType:t.deficiencyType})),inventory:n.inventory?.map(t=>({id:t.id,equipmentName:t.equipmentName,quantity:t.quantity,minQty:t.minQty}))})});if(!e.ok){if(e.status===501)return{ok:!1,message:"AI integration not configured"};const t=await e.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to generate insights: ${e.statusText}`)}return await e.json()}async function Q(){const n=await fetch(`${w}/ai/insights`,{method:"GET",headers:m(!0)});if(!n.ok){const e=await n.json().catch(()=>({error:"Unknown error"}));throw new Error(e.error||`Failed to fetch insights: ${n.statusText}`)}return await n.json()}async function N(){const n=await fetch(`${w}/apparatus-status`,{method:"GET",headers:m(!1)});if(!n.ok){const e=await n.json().catch(()=>({error:"Unknown error"}));throw new Error(e.error||`Failed to fetch apparatus status: ${n.statusText}`)}return await n.json()}async function K(n){const e=await fetch(`${w}/apparatus-status/request`,{method:"POST",headers:{"Content-Type":"application/json",...m(!1)},body:JSON.stringify(n)});if(!e.ok){const t=await e.json().catch(()=>({error:"Unknown error"}));throw new Error(t.error||`Failed to submit vehicle change request: ${e.statusText}`)}return await e.json()}async function W(n){const e=n?`${w}/apparatus-status/requests?status=${n}`:`${w}/apparatus-status/requests`,t=await fetch(e,{method:"GET",headers:m(!0)});if(!t.ok){const s=await t.json().catch(()=>({error:"Unknown error"}));throw new Error(s.error||`Failed to fetch vehicle change requests: ${t.statusText}`)}return await t.json()}async function Y(n,e,t,s){const r=await fetch(`${w}/apparatus-status/requests/${n}`,{method:"PATCH",headers:{"Content-Type":"application/json",...m(!0)},body:JSON.stringify({action:e,reviewedBy:t,notes:s})});if(!r.ok){const c=await r.json().catch(()=>({error:"Unknown error"}));throw new Error(c.error||`Failed to review vehicle change request: ${r.statusText}`)}return await r.json()}function Z(){const[n,e]=k.useState([]),[t,s]=k.useState(!0),[r,c]=k.useState(null),h=async()=>{s(!0),c(null);try{const i=await N();e(i.statuses)}catch(i){console.error("Error fetching apparatus status:",i),c(i instanceof Error?i.message:"Failed to fetch apparatus status")}finally{s(!1)}},a=i=>n.find(d=>d.unit===i)?.vehicleNo;return k.useEffect(()=>{h()},[]),{statuses:n,loading:t,error:r,refetch:h,getVehicleNumber:a}}export{O as C,G as M,H as T,I as X,U as a,R as b,B as c,V as d,J as e,z as f,q as g,Q as h,X as i,W as j,Y as r,K as s,Z as u};
//# sourceMappingURL=useApparatusStatus-bjC0xf9S.js.map
